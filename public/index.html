<!doctype html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WhatsApp Chatbot - UltraMSG</title>
    <style>
      :root {
        --bg: #0b1220;
        --panel: #101826;
        --border: #1f2a3a;
        --text: #e5edf5;
        --muted: #97a6b9;
        --primary: #4c7ef3;
        --primary-700: #375fd6;
        --incoming: #f59e9e;
        --outgoing: #97e6c9;
      }
      * { box-sizing: border-box; }
      body { font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; display: grid; place-items: center; }
      .container { width: 100%; max-width: 720px; padding: 24px; }
      .card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; box-shadow: 0 12px 24px rgba(0,0,0,0.35); }
      .title { margin: 0 0 8px; font-size: 22px; font-weight: 700; letter-spacing: 0.3px; }
      .subtitle { margin: 0 0 16px; color: var(--muted); font-size: 13px; }
      label { display:block; margin: 12px 0 6px; color: #b7cffc; font-size: 13px; }
      input, textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: #0c1422; color: var(--text); outline: none; }
      input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(76,126,243,0.2); }
      button { margin-top: 12px; background: var(--primary); color: white; border: none; padding: 12px 16px; border-radius: 10px; cursor: pointer; font-weight: 600; }
      button:hover { background: var(--primary-700); }
      button:disabled { background: #334155; cursor: not-allowed; }
      .section { margin-top: 18px; }
      .logs { max-height: 340px; overflow: auto; background: #0c1422; border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
      .log-item { padding: 10px; border-bottom: 1px dashed var(--border); }
      .log-item:last-child { border-bottom: none; }
      .outgoing { color: var(--outgoing); }
      .incoming { color: var(--incoming); }
      .muted { color: var(--muted); font-size: 12px; }
      .row { display: flex; gap: 12px; align-items: center; }
    </style>
  </head>
  <body>
    <div class="container">
      <section class="card">
        <h1 class="title">WhatsApp Chatbot</h1>
        <p class="subtitle">UltraMSG + Express Â· Dark modern UI</p>
        <label for="to">Recipient phone (with country code)</label>
        <input id="to" placeholder="e.g. 98912XXXXXXX or +98912XXXXXXX" />
        <label for="body">Message text</label>
        <textarea id="body" rows="4" placeholder="Hello! This is a test message."></textarea>
        <div class="row">
          <button id="sendBtn">Send Message</button>
          <p id="sendStatus" class="muted"></p>
        </div>

        <div class="section">
          <h2 class="title" style="font-size:18px;">Live incoming/outgoing logs</h2>
          <div class="logs" id="logs"></div>
        </div>
      </section>
    </div>

    <script>
      const toInput = document.getElementById('to');
      const bodyInput = document.getElementById('body');
      const sendBtn = document.getElementById('sendBtn');
      const sendStatus = document.getElementById('sendStatus');
      const logs = document.getElementById('logs');
      // Deduplication for rapid duplicate events (optimistic + SSE)
      const recentLogKeys = new Map();
      const DEDUP_WINDOW_MS = 3000;

      function addLog(event) {
        const dirNorm = event.direction === 'outgoing' ? 'outgoing' : 'incoming';
        const key = `${dirNorm}|${event.to || ''}|${event.from || ''}|${(event.body || '').trim()}`;
        const now = Date.now();
        const last = recentLogKeys.get(key) || 0;
        if (now - last < DEDUP_WINDOW_MS) {
          return; // skip duplicates arriving within short window
        }
        recentLogKeys.set(key, now);
        const el = document.createElement('div');
        el.className = 'log-item ' + dirNorm;
        const dir = dirNorm === 'outgoing' ? 'Outgoing' : 'Incoming';
        const who = event.direction === 'outgoing'
          ? (event.to ? `to ${event.to}` : '')
          : (event.from ? `from ${event.from}` : 'from Unknown');
        const time = new Date(event.at).toLocaleString('fa-IR');
        el.innerHTML = `<strong>${dir}</strong> ${who ? '('+who+')' : ''}<br/>` +
                       `${event.body ? event.body : '[No text]'}<br/>` +
                       `<span class="muted">${time}</span>`;
        logs.prepend(el);
      }

      // Subscribe to server-sent events
      const es = new EventSource('/events');
      es.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          addLog(data);
        } catch (_) {}
      };

      sendBtn.onclick = async () => {
        const to = toInput.value.trim();
        const body = bodyInput.value.trim();
        if (!to || !body) {
          sendStatus.textContent = 'Enter phone and message.';
          return;
        }
        sendBtn.disabled = true;
        sendStatus.textContent = 'Sending...';
        try {
          const res = await fetch('/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to, body })
          });
          const json = await res.json();
          if (json.ok) {
            sendStatus.textContent = 'Sent.';
            bodyInput.value = '';
            // optimistic log (in case SSE delays)
            addLog({ direction: 'outgoing', to, body, at: new Date().toISOString() });
          } else {
            sendStatus.textContent = 'Send error: ' + (json.error?.error || json.error || 'Unknown');
          }
        } catch (err) {
          sendStatus.textContent = 'Network error: ' + err.message;
        } finally {
          sendBtn.disabled = false;
        }
      };
    </script>
  </body>
  </html>