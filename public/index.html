<!doctype html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Multi-Channel Chatbot</title>
    <style>
      :root {
        --bg: #0b1220;
        --panel: #101826;
        --border: #1f2a3a;
        --text: #e5edf5;
        --muted: #97a6b9;
        --primary: #4c7ef3;
        --primary-700: #375fd6;
        --incoming: #f59e9e;
        --outgoing: #97e6c9;
        --whatsapp: #25d366;
        --instagram: #e4405f;
      }
      * { box-sizing: border-box; }
      body { font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; display: grid; place-items: center; }
      .container { width: 100%; max-width: 720px; padding: 24px; }
      .card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; box-shadow: 0 12px 24px rgba(0,0,0,0.35); }
      .title { margin: 0 0 8px; font-size: 22px; font-weight: 700; letter-spacing: 0.3px; }
      .subtitle { margin: 0 0 16px; color: var(--muted); font-size: 13px; }
      label { display:block; margin: 12px 0 6px; color: #b7cffc; font-size: 13px; }
      input, textarea, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: #0c1422; color: var(--text); outline: none; }
      input:focus, textarea:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(76,126,243,0.2); }
      button { margin-top: 12px; background: var(--primary); color: white; border: none; padding: 12px 16px; border-radius: 10px; cursor: pointer; font-weight: 600; }
      button:hover { background: var(--primary-700); }
      button:disabled { background: #334155; cursor: not-allowed; }
      .section { margin-top: 18px; }
      .logs { max-height: 340px; overflow: auto; background: #0c1422; border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
      .log-item { padding: 12px; border-bottom: 1px dashed var(--border); display: flex; align-items: flex-start; gap: 12px; }
      .log-item:last-child { border-bottom: none; }
      .log-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--border); flex-shrink: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; color: var(--muted); font-size: 12px; }
      .log-avatar img { width: 100%; height: 100%; object-fit: cover; }
      .log-content { flex: 1; }
      .log-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
      .log-platform { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
      .log-platform.whatsapp { background: rgba(37, 211, 102, 0.2); color: var(--whatsapp); }
      .log-platform.instagram { background: rgba(228, 64, 95, 0.2); color: var(--instagram); }
      .log-direction { font-weight: 600; font-size: 12px; }
      .log-user { font-size: 13px; color: var(--text); }
      .log-username { font-size: 11px; color: var(--muted); margin-left: 4px; }
      .log-message { margin: 6px 0; color: var(--text); line-height: 1.4; }
      .log-time { font-size: 11px; color: var(--muted); }
      .outgoing .log-direction { color: var(--outgoing); }
      .incoming .log-direction { color: var(--incoming); }
      .row { display: flex; gap: 12px; align-items: center; }
      
      /* Tab styles */
      .tabs { display: flex; gap: 4px; margin-bottom: 20px; }
      .tab { padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s; border: 1px solid var(--border); }
      .tab.whatsapp { background: rgba(37, 211, 102, 0.1); color: var(--whatsapp); }
      .tab.instagram { background: rgba(228, 64, 95, 0.1); color: var(--instagram); }
      .tab.active.whatsapp { background: var(--whatsapp); color: white; }
      .tab.active.instagram { background: var(--instagram); color: white; }
      .tab-content { display: none; }
      .tab-content.active { display: block; }
      
      /* Subscribers list */
      .subscribers { max-height: 200px; overflow: auto; background: #0c1422; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 12px; }
      .subscriber-item { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
      .subscriber-item:hover { background: rgba(76,126,243,0.1); }
      .subscriber-item.selected { background: var(--primary); color: white; }
      .subscriber-item:last-child { border-bottom: none; }
      .subscriber-name { font-weight: 600; }
      .subscriber-id { font-size: 11px; color: var(--muted); margin-top: 2px; }
    </style>
  </head>
  <body>
    <div class="container">
      <section class="card">
        <h1 class="title">Multi-Channel Chatbot</h1>
        <p class="subtitle">UltraMSG + SendPulse Â· Dark modern UI</p>
        
        <!-- Tabs -->
        <div class="tabs">
          <div class="tab whatsapp active" data-tab="whatsapp">WhatsApp</div>
          <div class="tab instagram" data-tab="instagram">Instagram</div>
        </div>

        <!-- WhatsApp Tab Content -->
        <div id="whatsapp-content" class="tab-content active">
          <label for="to">Recipient phone (with country code)</label>
          <input id="to" placeholder="e.g. 98912XXXXXXX or +98912XXXXXXX" />
          <label for="body">Message text</label>
          <textarea id="body" rows="4" placeholder="Hello! This is a test message."></textarea>
          <div class="row">
            <button id="sendBtn">Send Message</button>
            <p id="sendStatus" class="muted"></p>
          </div>
        </div>

        <!-- Instagram Tab Content -->
        <div id="instagram-content" class="tab-content">
          <label for="subscribers">Subscribers</label>
          <div class="subscribers" id="subscribers">
            <div class="subscriber-item" style="text-align: center; color: var(--muted); padding: 20px;">
              Loading subscribers...
            </div>
          </div>
          
          <label for="messageText">Message text</label>
          <textarea id="messageText" rows="4" placeholder="Hello! This is a test message."></textarea>
          <div class="row">
            <button id="sendToSelected" disabled>Send to selected</button>
            <p id="instagramSendStatus" class="muted"></p>
          </div>
        </div>

        <div class="section">
          <h2 class="title" style="font-size:18px;">Live incoming/outgoing logs</h2>
          <div class="logs" id="logs"></div>
        </div>
      </section>
    </div>

    <script>
      const toInput = document.getElementById('to');
      const bodyInput = document.getElementById('body');
      const sendBtn = document.getElementById('sendBtn');
      const sendStatus = document.getElementById('sendStatus');
      const logs = document.getElementById('logs');
      const messageTextInput = document.getElementById('messageText');
      const sendToSelectedBtn = document.getElementById('sendToSelected');
      const instagramSendStatus = document.getElementById('instagramSendStatus');
      const subscribersDiv = document.getElementById('subscribers');
      
      let selectedSubscriber = null;
      let subscribers = [];
      
      // Tab functionality
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          
          // Update active tab
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Update active content
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`${tabName}-content`).classList.add('active');
          
          // Load Instagram subscribers when switching to Instagram tab
          if (tabName === 'instagram') {
            loadInstagramSubscribers();
          }
        });
      });
      
      // Load Instagram subscribers
      async function loadInstagramSubscribers() {
        try {
          const response = await fetch('/instagram/subscribers');
          const data = await response.json();
          
          if (data.ok && data.subscribers) {
            subscribers = data.subscribers;
            renderSubscribers();
          } else {
            subscribersDiv.innerHTML = '<div class="subscriber-item" style="text-align: center; color: var(--muted); padding: 20px;">No subscribers found</div>';
          }
        } catch (error) {
          subscribersDiv.innerHTML = '<div class="subscriber-item" style="text-align: center; color: var(--muted); padding: 20px;">Error loading subscribers</div>';
        }
      }
      
      // Render subscribers list
      function renderSubscribers() {
        if (subscribers.length === 0) {
          subscribersDiv.innerHTML = '<div class="subscriber-item" style="text-align: center; color: var(--muted); padding: 20px;">No subscribers found</div>';
          return;
        }
        
        subscribersDiv.innerHTML = subscribers.map(sub => `
          <div class="subscriber-item" data-id="${sub.contact_id}">
            <div class="subscriber-name">${sub.name || sub.username || 'Unknown User'}</div>
            <div class="subscriber-id">${sub.contact_id}</div>
          </div>
        `).join('');
        
        // Add click handlers for subscriber selection
        document.querySelectorAll('.subscriber-item').forEach(item => {
          item.addEventListener('click', () => {
            // Remove previous selection
            document.querySelectorAll('.subscriber-item').forEach(i => i.classList.remove('selected'));
            
            // Select current item
            item.classList.add('selected');
            selectedSubscriber = item.dataset.id;
            sendToSelectedBtn.disabled = false;
          });
        });
      }
      
      // Instagram send message
      sendToSelectedBtn.onclick = async () => {
        const messageText = messageTextInput.value.trim();
        if (!selectedSubscriber || !messageText) {
          instagramSendStatus.textContent = 'Select subscriber and enter message.';
          return;
        }
        
        sendToSelectedBtn.disabled = true;
        instagramSendStatus.textContent = 'Sending...';
        
        try {
          const res = await fetch('/instagram/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contact_id: selectedSubscriber, message: messageText })
          });
          const json = await res.json();
          
          if (json.ok) {
            instagramSendStatus.textContent = 'Sent.';
            messageTextInput.value = '';
            // Add optimistic log
            addLog({ 
              direction: 'outgoing', 
              to: selectedSubscriber, 
              body: messageText, 
              at: new Date().toISOString(),
              platform: 'instagram'
            });
          } else {
            instagramSendStatus.textContent = 'Send error: ' + (json.error?.error || json.error || 'Unknown');
          }
        } catch (err) {
          instagramSendStatus.textContent = 'Network error: ' + err.message;
        } finally {
          sendToSelectedBtn.disabled = selectedSubscriber ? false : true;
        }
      };
      
      // Deduplication for rapid duplicate events (optimistic + SSE)
      const recentLogKeys = new Map();
      const DEDUP_WINDOW_MS = 3000;

      function addLog(event) {
        const dirNorm = event.direction === 'outgoing' ? 'outgoing' : 'incoming';
        const platform = event.platform || 'whatsapp'; // Default to WhatsApp if no platform specified
        const key = `${dirNorm}|${platform}|${event.to || ''}|${event.from || ''}|${(event.body || '').trim()}`;
        const now = Date.now();
        const last = recentLogKeys.get(key) || 0;
        if (now - last < DEDUP_WINDOW_MS) {
          return; // skip duplicates arriving within short window
        }
        recentLogKeys.set(key, now);
        
        const el = document.createElement('div');
        el.className = 'log-item ' + dirNorm;
        
        const dir = dirNorm === 'outgoing' ? 'Outgoing' : 'Incoming';
        const time = new Date(event.at).toLocaleString('fa-IR');
        
        // Create avatar
        const avatar = document.createElement('div');
        avatar.className = 'log-avatar';
        
        if (platform === 'instagram' && event.photo) {
          const img = document.createElement('img');
          img.src = event.photo;
          img.alt = event.from || 'User';
          img.onerror = () => {
            avatar.innerHTML = (event.from || 'U').charAt(0).toUpperCase();
          };
          avatar.appendChild(img);
        } else {
          avatar.innerHTML = (event.from || 'U').charAt(0).toUpperCase();
        }
        
        // Create content
        const content = document.createElement('div');
        content.className = 'log-content';
        
        const header = document.createElement('div');
        header.className = 'log-header';
        
        const platformBadge = document.createElement('span');
        platformBadge.className = `log-platform ${platform}`;
        platformBadge.textContent = platform === 'instagram' ? 'Instagram' : 'WhatsApp';
        
        const direction = document.createElement('span');
        direction.className = 'log-direction';
        direction.textContent = dir;
        
        const user = document.createElement('span');
        user.className = 'log-user';
        
        if (event.direction === 'outgoing') {
          user.textContent = event.to ? `to ${event.to}` : '';
        } else {
          user.textContent = event.from || 'Unknown';
          
          // Add username for Instagram
          if (platform === 'instagram' && event.username) {
            const username = document.createElement('span');
            username.className = 'log-username';
            username.textContent = `@${event.username}`;
            user.appendChild(username);
          }
        }
        
        header.appendChild(platformBadge);
        header.appendChild(direction);
        if (user.textContent || user.children.length > 0) {
          header.appendChild(user);
        }
        
        const message = document.createElement('div');
        message.className = 'log-message';
        message.textContent = event.body || '[No text]';
        
        const timeEl = document.createElement('div');
        timeEl.className = 'log-time';
        timeEl.textContent = time;
        
        content.appendChild(header);
        content.appendChild(message);
        content.appendChild(timeEl);
        
        el.appendChild(avatar);
        el.appendChild(content);
        
        logs.prepend(el);
      }

      // Subscribe to server-sent events
      const es = new EventSource('/events');
      es.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          addLog(data);
        } catch (_) {}
      };

      sendBtn.onclick = async () => {
        const to = toInput.value.trim();
        const body = bodyInput.value.trim();
        if (!to || !body) {
          sendStatus.textContent = 'Enter phone and message.';
          return;
        }
        sendBtn.disabled = true;
        sendStatus.textContent = 'Sending...';
        try {
          const res = await fetch('/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to, body })
          });
          const json = await res.json();
          if (json.ok) {
            sendStatus.textContent = 'Sent.';
            bodyInput.value = '';
            // optimistic log (in case SSE delays)
            addLog({ direction: 'outgoing', to, body, at: new Date().toISOString(), platform: 'whatsapp' });
          } else {
            sendStatus.textContent = 'Send error: ' + (json.error?.error || json.error || 'Unknown');
          }
        } catch (err) {
          sendStatus.textContent = 'Network error: ' + err.message;
        } finally {
          sendBtn.disabled = false;
        }
      };
    </script>
  </body>
  </html>